# HAProxy configuration for keycast scale testing
#
# Optimized for high throughput with sticky sessions (Authorization header)
# Usage: docker-compose -f docker-compose.scale.yml -f docker-compose.haproxy.yml up -d --scale keycast=8

global
    maxconn 50000
    # Use multiple threads for better throughput
    nbthread 8
    # Disable logging for performance
    log /dev/null local0

defaults
    mode http
    # Timeouts optimized for low-latency
    timeout connect 1s
    timeout client 30s
    timeout server 30s
    # Keep connections alive
    option http-keep-alive
    # Don't log for performance
    option dontlognull

frontend http_front
    bind *:80
    default_backend keycast_backends

backend keycast_backends
    # Balance using Authorization header hash (sticky sessions)
    # Same token always hits same backend
    balance hdr(Authorization)
    hash-type consistent

    # Health check
    option httpchk GET /health
    http-check expect status 200

    # Dynamic server resolution for docker-compose scaling
    # Servers are discovered via DNS (keycast resolves to all instances)
    server-template keycast 20 keycast:3000 check resolvers docker init-addr libc,none

resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 5s
